'use strict';
angular.module('myApp.list', ['ngRoute', 'templates'])

.config(['$routeProvider', function($routeProvider) {
  $routeProvider.when('/lists/:id/tasks', {
    templateUrl: '<%= asset_path("list.html") %>',
    controller: 'ListCtrl',
    resolve: {
      jsonGrab: ['$http', '$route', function($http, $route) {
        return $http.get('/api/lists/' + $route.current.params.id + '/tasks').then(function(response) {
          return response.data;
        });
      }],
    }
  });
}])

.controller('ListCtrl', ['$scope', 'jsonGrab', '$http', function($scope, jsonGrab, $http) {
  $scope.taskJson = jsonGrab.tasks;
  $scope.newTaskText = "";
  $scope.listJson = jsonGrab.list;

  $scope.destroyRoute = function(list, task){
    $http.delete('/api/lists/' + list.id + '/tasks/' + task.id).success(function(reply, status){
      if (status === 204) {
        $scope.taskJson.splice($scope.taskJson.indexOf(task), 1);
      };
    })
  }

  $scope.createRoute = function(list, task){
    $http.post('/api/lists/' + list.id + '/tasks/', {text: task}).success( function(newCreatedTask){
      $scope.taskJson.push(newCreatedTask);
      $scope.newTaskText = "";
    })
  }

  $scope.updateRoute = function(list, task){
    $http.patch('/api/lists/' + list.id + '/tasks/' + task.id, {completed: task.completed})
  }
}]);